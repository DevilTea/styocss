import type { StyoPluginContext } from './types'

function formatUnionType(types: string[]) {
	return types.length > 0 ? types.join(' | ') : 'never'
}

export function generateDtsContent({
	ctx: {
		engine,
		autoJoin,
		nameOfStyoFn,
	},
	hasVue,
}: {
	ctx: StyoPluginContext
	hasVue: boolean
}) {
	const aliasForNestingList = [
		...engine.staticAliasForNestingRuleList.map(({ alias }) => alias),
		...engine.dynamicAliasForNestingRuleList.flatMap(({ predefined }) => predefined),
	].map(alias => `'${alias}'`)
	const aliasForNestingTemplateList = [
		...engine.dynamicAliasForNestingRuleList.flatMap(({ template }) => template),
	].map(template => `'${template}'`)
	const aliasForSelectorList = [
		...engine.staticAliasForSelectorRuleList.map(({ alias }) => alias),
		...engine.dynamicAliasForSelectorRuleList.flatMap(({ predefined }) => predefined),
	].map(alias => `'${alias}'`)
	const aliasForSelectorTemplateList = [
		...engine.dynamicAliasForSelectorRuleList.flatMap(({ template }) => template),
	].map(template => `'${template}'`)
	const shortcutList = [
		...engine.staticShortcutRuleList.map(({ name }) => name),
		...engine.dynamicShortcutRuleList.flatMap(({ predefined }) => predefined),
	].map(name => `'${name}'`)
	const shortcutTemplateList = [
		...engine.dynamicShortcutRuleList.flatMap(({ template }) => template),
	].map(template => `'${template}'`)

	const lines = []
	lines.push(...[
		'// Auto-generated by @styocss/vite-plugin-styocss',
		'import type { StyoEngine } from \'@styocss/vite-plugin-styocss\'',
		'',
		'type _StyoFn = StyoEngine<',
		`  /* AliasForNesting */ ${formatUnionType(aliasForNestingList)},`,
		`  /* AliasForNestingTemplate */ ${formatUnionType(aliasForNestingTemplateList)},`,
		`  /* AliasForSelector */ ${formatUnionType(aliasForSelectorList)},`,
		`  /* AliasForSelectorTemplate */ ${formatUnionType(aliasForSelectorTemplateList)},`,
		`  /* Shortcut */ ${formatUnionType(shortcutList)},`,
		`  /* ShortcutTemplate */ ${formatUnionType(shortcutTemplateList)},`,
		'>[\'styo\']',
		'',
	])

	if (autoJoin) {
		lines.push(...[
			'type StyoFn = (...params: Parameters<_StyoFn>) => string',
			'',
		])
	}
	else {
		lines.push(...[
			'type StyoFn = _StyoFn',
			'',
		])
	}

	lines.push(...[
		'declare global {',
		`  const ${nameOfStyoFn}: StyoFn`,
		'}',
		'',
	])

	if (hasVue) {
		lines.push(...[
			'declare module \'vue\' {',
			'  interface ComponentCustomProperties {',
			`    ${nameOfStyoFn}: StyoFn`,
			'  }',
			'}',
			'',
		])
	}

	return lines.join('\n')
}
